stages:
  - test

  - deploy

variables:
  NODE_ENV: production

  PLAYWRIGHT_BROWSERS_PATH: /ms-playwright

  PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

cache:
  paths:
    - node_modules/

    - .npm/

  key:
    files:
      - package-lock.json

    prefix: ${CI_COMMIT_REF_SLUG}

playwright_tests:
  stage: test

  image: mcr.microsoft.com/playwright:v1.49.0-noble

  before_script:
    - node -v

    - npm -v

  script:
    # Remove any cached/corrupted node_modules

    - rm -rf node_modules

    # Fresh install of all dependencies (ignore engine warnings)

    - npm install --force

    # Verify Playwright is installed

    - npm list @playwright/test

    - npx playwright --version

    # Install browser binaries

    - npx playwright install --with-deps chromium

    # Run tests

    - npx playwright test --reporter=html,junit

  artifacts:
    when: always

    expire_in: 7 days

    paths:
      - playwright-report/

      - test-results/

    reports:
      junit: playwright-report/results.xml

  retry:
    max: 1

    when:
      - runner_system_failure

      - stuck_or_timeout_failure

pages:
  stage: deploy

  dependencies:
    - playwright_tests

  image: alpine:latest

  script:
    - mkdir -p public

    - |

      if [ -d "playwright-report" ]; then

        cp -r playwright-report/* public/

      else

        echo "<h1>No test report available</h1>" > public/index.html

      fi

  artifacts:
    paths:
      - public

  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

    - if: $CI_COMMIT_BRANCH == "main"

    - if: $CI_COMMIT_BRANCH == "master"

  environment:
    name: production

    url: $CI_PAGES_URL
