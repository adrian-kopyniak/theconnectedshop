stages:
  - test

  - deploy

variables:
  NODE_ENV: production

playwright_tests:
  stage: test

  image: mcr.microsoft.com/playwright:v1.57.0-noble

  before_script:
    - node -v

    - npm -v

  script:
    # Check package.json

    - cat package.json

    # Clean everything

    - rm -rf node_modules package-lock.json

    # Install packages one by one to debug

    - npm install @playwright/test@1.57.0 --save-dev

    - npm install @faker-js/faker@10.1.0 --save-dev

    - npm install @types/node@24.9.2 --save-dev

    - npm install allure-playwright@3.4.2 --save-dev

    - npm install fs-extra@11.3.2 --save-dev

    - npm install prettier@3.6.2 --save-dev

    # Verify installation

    - ls -la node_modules/@playwright/

    - npx playwright --version

    # Install browsers

    - npx playwright install chromium

    # Run tests

    - npx playwright test --reporter=html,junit

  artifacts:
    when: always

    expire_in: 7 days

    paths:
      - playwright-report/

      - test-results/

    reports:
      junit: playwright-report/results.xml

  retry:
    max: 1

    when:
      - runner_system_failure

      - stuck_or_timeout_failure

  allow_failure: false

pages:
  stage: deploy

  dependencies:
    - playwright_tests

  image: alpine:latest

  script:
    - mkdir -p public

    - |

      if [ -d "playwright-report" ]; then

        cp -r playwright-report/* public/

      else

        echo "<h1>No test report available</h1>" > public/index.html

      fi

  artifacts:
    paths:
      - public

  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

    - if: $CI_COMMIT_BRANCH == "main"

    - if: $CI_COMMIT_BRANCH == "master"

  environment:
    name: production

    url: $CI_PAGES_URL
