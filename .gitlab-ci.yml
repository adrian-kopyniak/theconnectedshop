stages:
  - test

  - deploy

variables:
  NODE_ENV: production

playwright_tests:
  stage: test

  image: mcr.microsoft.com/playwright:v1.57.0-noble

  before_script:
    - node -v

    - npm -v

  script:
    # Check if package.json exists and show its content

    - echo "=== Checking package.json ==="

    - ls -la package.json

    - cat package.json

    - echo "=== End of package.json ==="

    # Clean install

    - rm -rf node_modules package-lock.json

    - npm install --legacy-peer-deps

    # Show what's installed

    - echo "=== Checking node_modules ==="

    - ls -la node_modules/ | head -20

    - ls -la node_modules/@playwright/ || echo "Playwright not in node_modules"

    - npm list @playwright/test || echo "Not in package list"

    # Try to run playwright

    - npx playwright install chromium

    - npx playwright test --reporter=html,junit

  artifacts:
    when: always

    expire_in: 7 days

    paths:
      - playwright-report/

      - test-results/

    reports:
      junit: playwright-report/results.xml

  retry:
    max: 1

    when:
      - runner_system_failure

      - stuck_or_timeout_failure

  allow_failure: false

pages:
  stage: deploy

  dependencies:
    - playwright_tests

  image: alpine:latest

  script:
    - mkdir -p public

    - |

      if [ -d "playwright-report" ]; then

        cp -r playwright-report/* public/

      else

        echo "<h1>No test report available</h1>" > public/index.html

      fi

  artifacts:
    paths:
      - public

  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

    - if: $CI_COMMIT_BRANCH == "main"

    - if: $CI_COMMIT_BRANCH == "master"

  environment:
    name: production

    url: $CI_PAGES_URL
