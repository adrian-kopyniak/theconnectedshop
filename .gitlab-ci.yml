stages:
  - test

  - deploy

variables:
  NODE_ENV: production

  PLAYWRIGHT_BROWSERS_PATH: /ms-playwright

cache:
  paths:
    - node_modules/

    - .npm/

  key: ${CI_COMMIT_REF_SLUG}

playwright_tests:
  stage: test

  image: mcr.microsoft.com/playwright:v1.57.0-focal

  script:
    - node -v

    - npm ci --no-audit

    - npx playwright install --with-deps

    - npx playwright test --reporter=html

  artifacts:
    when: always

    expire_in: 7 days

    paths:
      - playwright-report/

    reports:
      junit: playwright-report/junit.xml

pages:
  stage: deploy

  dependencies:
    - playwright_tests

  image: alpine:latest

  script:
    - mkdir -p public

    - cp -r playwright-report/* public/ 2>/dev/null || echo "No report found"

  artifacts:
    paths:
      - public

  only:
    - main

    - master
