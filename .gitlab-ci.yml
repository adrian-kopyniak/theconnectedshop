stages:
  - test

  - deploy

variables:
  NODE_ENV: production

playwright_tests:
  stage: test

  image: mcr.microsoft.com/playwright:v1.57.0-noble

  before_script:
    - node -v

    - npm -v

  script:
    # Debug: show all files including hidden

    - ls -la

    - cat .npmrc 2>/dev/null || echo "No .npmrc"

    - cat .gitignore 2>/dev/null || echo "No .gitignore"

    # Check npm config

    - npm config list

    # Try with --force and --verbose to see what's happening

    - npm install --force --verbose @playwright/test

    # If that fails, try global install

    - npm install -g @playwright/test || true

    # Install browsers

    - npx playwright install chromium || playwright install chromium

    # Run tests

    - npx playwright test --reporter=html,junit || playwright test --reporter=html,junit

  artifacts:
    when: always

    expire_in: 7 days

    paths:
      - playwright-report/

      - test-results/

    reports:
      junit: playwright-report/results.xml

  retry:
    max: 1

    when:
      - runner_system_failure

      - stuck_or_timeout_failure

  allow_failure: false

pages:
  stage: deploy

  dependencies:
    - playwright_tests

  image: alpine:latest

  script:
    - mkdir -p public

    - |

      if [ -d "playwright-report" ]; then

        cp -r playwright-report/* public/

      else

        echo "<h1>No test report available</h1>" > public/index.html

      fi

  artifacts:
    paths:
      - public

  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

    - if: $CI_COMMIT_BRANCH == "main"

    - if: $CI_COMMIT_BRANCH == "master"

  environment:
    name: production

    url: $CI_PAGES_URL
